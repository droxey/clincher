---
# OpenClaw Hardened Single-Server Deployment
#
# Usage:
#   Full deploy:  ansible-playbook playbook.yml --ask-vault-pass
#   Specific role: ansible-playbook playbook.yml --ask-vault-pass --tags harden
#   Dry run:      ansible-playbook playbook.yml --ask-vault-pass --check --diff
#
# Tags: base, config, deploy, harden, integrate, proxy, verify, maintenance, monitoring

# ── Bootstrap: transition fresh servers from port 22 → ssh_port ──────────
# On a fresh VPS, SSH listens on port 22 as root. This play connects on
# port 22, creates the deploy user, opens the hardened SSH port, and reloads
# sshd. It is a no-op if ssh_port is already reachable (idempotent re-runs).
- name: Bootstrap SSH on fresh server
  hosts: openclaw
  gather_facts: false
  become: true
  tags: [base]
  vars:
    ansible_port: 22
    ansible_user: root

  tasks:
    - name: Check if target SSH port is already reachable
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: "{{ ssh_port }}"
        timeout: 5
      delegate_to: localhost
      become: false
      ignore_errors: true
      register: target_port_check

    - name: Bootstrap SSH hardening
      when: target_port_check is failed
      block:
        - name: Gather facts for bootstrap
          ansible.builtin.setup:

        - name: Create deploy user
          ansible.builtin.user:
            name: "{{ deploy_user }}"
            groups: sudo
            append: true
            shell: /bin/bash
            create_home: true

        - name: Ensure .ssh directory for deploy user
          ansible.builtin.file:
            path: "/home/{{ deploy_user }}/.ssh"
            state: directory
            owner: "{{ deploy_user }}"
            group: "{{ deploy_user }}"
            mode: "0700"

        - name: Copy root authorized_keys to deploy user
          ansible.builtin.copy:
            src: /root/.ssh/authorized_keys
            dest: "/home/{{ deploy_user }}/.ssh/authorized_keys"
            remote_src: true
            owner: "{{ deploy_user }}"
            group: "{{ deploy_user }}"
            mode: "0600"
            force: false

        - name: Grant deploy user passwordless sudo
          ansible.builtin.copy:
            content: "{{ deploy_user }} ALL=(ALL) NOPASSWD: ALL\n"
            dest: "/etc/sudoers.d/{{ deploy_user }}"
            owner: root
            group: root
            mode: "0440"
            validate: "visudo -cf %s"

        - name: Install UFW
          ansible.builtin.apt:
            name: ufw
            state: present
            update_cache: true
            cache_valid_time: 3600

        - name: Allow SSH on target port before switching
          community.general.ufw:
            rule: allow
            to_port: "{{ ssh_port }}"
            proto: tcp

        - name: Deploy SSH hardening config
          ansible.builtin.template:
            src: roles/base/templates/99-hardening.conf.j2
            dest: /etc/ssh/sshd_config.d/99-hardening.conf
            owner: root
            group: root
            mode: "0644"

        - name: Reload SSH to activate new port
          ansible.builtin.systemd:
            name: ssh
            state: reloaded

        - name: Wait for SSH on new port
          ansible.builtin.wait_for:
            host: "{{ ansible_host }}"
            port: "{{ ssh_port }}"
            delay: 2
            timeout: 30
          delegate_to: localhost
          become: false

# ── Main Deployment ──────────────────────────────────────────────────────
- name: Deploy OpenClaw (hardened single-server)
  hosts: openclaw
  become: true

  pre_tasks:
    - name: Validate required variables
      tags: [always]
      block:
        - name: Ensure LLM provider API key is configured
          ansible.builtin.assert:
            that:
              - anthropic_api_key is defined
              - anthropic_api_key | length > 0
              - anthropic_api_key != 'sk-ant-your-key-here'
            fail_msg: "anthropic_api_key must be set in vault.yml (not the placeholder value)"

        - name: Ensure Voyage API key is configured
          ansible.builtin.assert:
            that:
              - voyage_api_key is defined
              - voyage_api_key | length > 0
              - voyage_api_key != 'pa-your-key-here'
            fail_msg: "voyage_api_key must be set in vault.yml (not the placeholder value)"

        - name: Ensure tunnel token is set when using Cloudflare Tunnel
          ansible.builtin.assert:
            that:
              - tunnel_token is defined
              - tunnel_token | length > 0
              - tunnel_token != 'YOUR_TUNNEL_TOKEN'
            fail_msg: "tunnel_token must be set in vault.yml when reverse_proxy is 'tunnel'"
          when: reverse_proxy == 'tunnel'

        - name: Ensure admin_ip is configured
          ansible.builtin.assert:
            that:
              - admin_ip != 'YOUR_STATIC_IP'
            fail_msg: "admin_ip must be set to your actual IP in vars.yml"

        - name: Ensure domain is configured
          ansible.builtin.assert:
            that:
              - domain != 'openclaw.yourdomain.com'
            fail_msg: "domain must be set to your actual domain in vars.yml"

    - name: Generate secrets that were left empty
      tags: [always]
      block:
        - name: Generate LiteLLM master key
          ansible.builtin.set_fact:
            litellm_master_key: "{{ lookup('ansible.builtin.password', '/dev/null chars=hexdigits length=64') }}"
          when: litellm_master_key | default('') | length == 0

        - name: Generate gateway token
          ansible.builtin.set_fact:
            gateway_token: "{{ lookup('ansible.builtin.password', '/dev/null chars=hexdigits length=64') }}"
          when: gateway_token | default('') | length == 0

        - name: Generate backup encryption key
          ansible.builtin.set_fact:
            backup_encryption_key: "{{ lookup('ansible.builtin.password', '/dev/null chars=hexdigits length=64') }}"
          when: backup_encryption_key | default('') | length == 0

  roles:
    - role: base
      tags: [base]
    - role: openclaw-config
      tags: [config]
    - role: openclaw-deploy
      tags: [deploy]
    - role: openclaw-harden
      tags: [harden]
    - role: openclaw-integrate
      tags: [integrate]
    - role: reverse-proxy
      tags: [proxy]
    - role: verify
      tags: [verify]
    - role: maintenance
      tags: [maintenance]
    - role: monitoring
      tags: [monitoring]
      when: monitoring_enabled | bool
