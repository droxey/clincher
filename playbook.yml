---
# OpenClaw Hardened Single-Server Deployment
#
# Usage:
#   First run:    ansible-playbook playbook.yml --ask-pass --ask-vault-pass
#   After keys:   ansible-playbook playbook.yml --ask-vault-pass
#   Specific role: ansible-playbook playbook.yml --ask-vault-pass --tags harden
#   Dry run:      ansible-playbook playbook.yml --ask-vault-pass --check --diff
#
# First run requires --ask-pass (-k) so Ansible can SSH to root with a password.
# Prerequisite: apt install sshpass (needed for Ansible to send SSH passwords).
# After bootstrap pushes your SSH key, subsequent runs use key-based auth only.
#
# Tags: base, config, deploy, harden, integrate, proxy, verify, maintenance, monitoring

# ── Bootstrap: ensure deploy user can SSH on ssh_port ────────────────────
# Handles three server states:
#   1. Fresh VPS (SSH on port 22, root only)        → bootstrap via root:22
#   2. Partially hardened (SSH on ssh_port, root ok) → bootstrap via root:ssh_port
#   3. Fully provisioned (deploy user works)         → no-op
- name: Bootstrap deploy user
  hosts: openclaw
  gather_facts: false
  become: true
  tags: [base]
  vars:
    ansible_user: root

  tasks:
    # ── Phase 1: Test if the deploy user can already authenticate ────────
    - name: Check if local SSH key exists
      ansible.builtin.stat:
        path: "{{ local_ssh_key_path }}"
      delegate_to: localhost
      become: false
      register: local_key_stat

    - name: Test deploy user SSH access
      ansible.builtin.command: >
        ssh -o BatchMode=yes -o ConnectTimeout=5
        -o StrictHostKeyChecking=accept-new
        -o IdentitiesOnly=yes
        {{ '-i ' + local_ssh_key_path if local_key_stat.stat.exists else '' }}
        -p {{ ssh_port }} {{ deploy_user }}@{{ ansible_host }} echo ok
      delegate_to: localhost
      become: false
      ignore_errors: true
      register: deploy_ssh_check
      changed_when: false

    - name: Skip bootstrap when deploy user is accessible
      ansible.builtin.meta: end_play
      when: deploy_ssh_check.rc == 0

    # ── Phase 2: Find a port where root can connect ─────────────────────
    - name: Check configured SSH port ({{ ssh_port }})
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: "{{ ssh_port }}"
        timeout: 5
      delegate_to: localhost
      become: false
      ignore_errors: true
      register: configured_port_check

    - name: Check default SSH port (22)
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: 22
        timeout: 5
      delegate_to: localhost
      become: false
      ignore_errors: true
      register: default_port_check
      when: configured_port_check is failed

    - name: Fail if no SSH port is reachable
      ansible.builtin.fail:
        msg: >
          Cannot reach {{ ansible_host }} on port {{ ssh_port }} or port 22.
          Verify the server is running and the IP is correct in inventory/hosts.yml.
      when: >
        configured_port_check is failed and
        (default_port_check is not defined or default_port_check is failed)

    - name: Set bootstrap port (prefer configured, fall back to 22)
      ansible.builtin.set_fact:
        ansible_port: "{{ ssh_port if (configured_port_check is succeeded) else 22 }}"

    # ── Phase 3: Provision deploy user via root ─────────────────────────
    - name: Check sshpass is installed (required for password-based bootstrap)
      ansible.builtin.command: which sshpass
      delegate_to: localhost
      become: false
      changed_when: false
      failed_when: false
      register: sshpass_check

    - name: Fail if sshpass is missing
      ansible.builtin.fail:
        msg: >
          sshpass is required for password-based SSH bootstrap (--ask-pass).
          Install it: apt install sshpass — then re-run.
      when: sshpass_check.rc != 0

    - name: Gather facts
      ansible.builtin.setup:

    - name: Ensure local SSH key exists
      ansible.builtin.command:
        cmd: ssh-keygen -t ed25519 -f {{ local_ssh_key_path }} -N "" -C "deploy@clincher"
      args:
        creates: "{{ local_ssh_key_path }}"
      delegate_to: localhost
      become: false

    - name: Read local SSH public key
      ansible.builtin.set_fact:
        local_ssh_pubkey: "{{ lookup('file', local_ssh_key_path + '.pub') }}"

    - name: Create deploy user
      ansible.builtin.user:
        name: "{{ deploy_user }}"
        groups: sudo
        append: true
        shell: /bin/bash
        create_home: true

    - name: Ensure .ssh directory for deploy user
      ansible.builtin.file:
        path: "/home/{{ deploy_user }}/.ssh"
        state: directory
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0700"

    - name: Push local SSH key to deploy user
      ansible.builtin.copy:
        content: "{{ local_ssh_pubkey }}\n"
        dest: "/home/{{ deploy_user }}/.ssh/authorized_keys"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: "0600"
        force: false

    - name: Ensure root .ssh directory
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Push local SSH key to root
      ansible.builtin.lineinfile:
        path: /root/.ssh/authorized_keys
        line: "{{ local_ssh_pubkey }}"
        create: true
        owner: root
        group: root
        mode: "0600"

    - name: Grant deploy user passwordless sudo
      ansible.builtin.copy:
        content: "{{ deploy_user }} ALL=(ALL) NOPASSWD: ALL\n"
        dest: "/etc/sudoers.d/{{ deploy_user }}"
        owner: root
        group: root
        mode: "0440"
        validate: "visudo -cf %s"

    - name: Verify deploy user can connect with SSH key
      ansible.builtin.command: >
        ssh -o BatchMode=yes -o ConnectTimeout=5
        -o StrictHostKeyChecking=accept-new
        -i {{ local_ssh_key_path }}
        -p {{ ansible_port }} {{ deploy_user }}@{{ ansible_host }} echo ok
      delegate_to: localhost
      become: false
      changed_when: false
      register: deploy_key_check

    - name: Warn if deploy user key auth failed
      ansible.builtin.debug:
        msg: >
          WARNING: Deploy user key-based auth failed. SSH hardening
          (which disables password auth) will be deferred to the base role.
          Re-run the playbook after investigating.
      when: deploy_key_check.rc != 0

# ── Main Deployment ──────────────────────────────────────────────────────
- name: Deploy OpenClaw (hardened single-server)
  hosts: openclaw
  become: true

  pre_tasks:
    - name: Validate required variables
      tags: [always]
      block:
        - name: Ensure LLM provider API key is configured
          ansible.builtin.assert:
            that:
              - anthropic_api_key is defined
              - anthropic_api_key | length > 0
              - anthropic_api_key != 'sk-ant-your-key-here'
            fail_msg: "anthropic_api_key must be set in vault.yml (not the placeholder value)"

        - name: Ensure Voyage API key is configured
          ansible.builtin.assert:
            that:
              - voyage_api_key is defined
              - voyage_api_key | length > 0
              - voyage_api_key != 'pa-your-key-here'
            fail_msg: "voyage_api_key must be set in vault.yml (not the placeholder value)"

        - name: Ensure tunnel token is set when using Cloudflare Tunnel
          ansible.builtin.assert:
            that:
              - tunnel_token is defined
              - tunnel_token | length > 0
              - tunnel_token != 'YOUR_TUNNEL_TOKEN'
            fail_msg: "tunnel_token must be set in vault.yml when reverse_proxy is 'tunnel'"
          when: reverse_proxy == 'tunnel'

        - name: Ensure admin_ip is configured
          ansible.builtin.assert:
            that:
              - admin_ip != 'YOUR_STATIC_IP'
            fail_msg: "admin_ip must be set to your actual IP in vars.yml"

        - name: Ensure domain is configured
          ansible.builtin.assert:
            that:
              - domain != 'openclaw.yourdomain.com'
            fail_msg: "domain must be set to your actual domain in vars.yml"

    - name: Generate secrets that were left empty
      tags: [always]
      block:
        - name: Generate LiteLLM master key
          ansible.builtin.set_fact:
            litellm_master_key: "{{ lookup('ansible.builtin.password', '/dev/null chars=hexdigits length=64') }}"
          when: litellm_master_key | default('') | length == 0

        - name: Generate gateway token
          ansible.builtin.set_fact:
            gateway_token: "{{ lookup('ansible.builtin.password', '/dev/null chars=hexdigits length=64') }}"
          when: gateway_token | default('') | length == 0

        - name: Generate backup encryption key
          ansible.builtin.set_fact:
            backup_encryption_key: "{{ lookup('ansible.builtin.password', '/dev/null chars=hexdigits length=64') }}"
          when: backup_encryption_key | default('') | length == 0

  roles:
    - role: base
      tags: [base]
    - role: openclaw-config
      tags: [config]
    - role: openclaw-deploy
      tags: [deploy]
    - role: openclaw-harden
      tags: [harden]
    - role: openclaw-integrate
      tags: [integrate]
    - role: reverse-proxy
      tags: [proxy]
    - role: verify
      tags: [verify]
    - role: maintenance
      tags: [maintenance]
    - role: monitoring
      tags: [monitoring]
      when: monitoring_enabled | bool
