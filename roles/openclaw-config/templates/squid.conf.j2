http_port 3128

# Only allow HTTPS port (443)
acl Safe_ports port 443
http_access deny !Safe_ports

# Restrict client source to the Docker bridge subnet.
# Ansible tightens this after first deploy (openclaw-deploy role).
# Default: broad match for initial startup; narrowed to actual subnet post-deploy.
acl localnet src 172.16.0.0/12
http_access deny !localnet

# Whitelist LLM provider API domains
{% for domain in squid_allowed_domains %}
acl llm_apis dstdomain {{ domain }}
{% endfor %}
{% if squid_extra_domains is defined %}
{% for domain in squid_extra_domains %}
acl llm_apis dstdomain {{ domain }}
{% endfor %}
{% endif %}

# CONNECT tunneling (used for all HTTPS requests through the proxy)
acl CONNECT method CONNECT
http_access deny CONNECT !llm_apis
http_access allow CONNECT llm_apis

# Allow plain HTTP(S) forwarding to whitelisted domains only
http_access allow llm_apis

# Deny everything else
http_access deny all

# Hardening
via off
forwarded_for delete
httpd_suppress_version_string on

# Memory tuning — keep Squid lean (container limit: {{ squid_memory }})
cache_mem 32 MB
maximum_object_size_in_memory 256 KB
# Disable disk cache — this proxy only tunnels CONNECT requests to LLM APIs
cache deny all
