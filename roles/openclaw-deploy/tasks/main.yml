---
# Step 4: Build egress image, deploy containers, verify health

- name: Pull container images
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop:
    - "ghcr.io/openclaw/openclaw:{{ openclaw_version }}"
    - "ghcr.io/tecnativa/docker-socket-proxy:{{ docker_proxy_version }}"
    - "ghcr.io/berriai/litellm:{{ litellm_version }}"
    - "redis/redis-stack-server:{{ redis_version }}"

- name: Build Smokescreen egress proxy image
  ansible.builtin.command: docker compose build openclaw-egress
  args:
    chdir: "{{ openclaw_base_dir }}"
  register: smokescreen_build
  changed_when: "'Successfully built' in smokescreen_build.stdout or 'exporting to image' in smokescreen_build.stdout"

- name: Start OpenClaw stack
  community.docker.docker_compose_v2:
    project_src: "{{ openclaw_base_dir }}"
    state: present
  register: compose_result

- name: Wait for all containers to become healthy
  ansible.builtin.command: docker inspect {{ item }} --format '{{ '{{' }}.State.Health.Status{{ '}}' }}'
  register: health_check
  until: health_check.stdout == 'healthy'
  retries: 20
  delay: 5
  changed_when: false
  loop:
    - openclaw-docker-proxy
    - openclaw-egress
    - openclaw-redis
    - openclaw-litellm
    - openclaw

# ── Discover proxy-net subnet for trustedProxies (used by harden role) ─
- name: Get proxy-net subnet
  ansible.builtin.command: >
    docker network inspect openclaw_proxy-net
    --format '{{ '{{' }}range .IPAM.Config{{ '}}' }}{{ '{{' }}.Subnet{{ '}}' }}{{ '{{' }}end{{ '}}' }}'
  register: proxy_subnet_result
  changed_when: false

- name: Store proxy-net subnet as fact
  ansible.builtin.set_fact:
    proxy_net_subnet: "{{ proxy_subnet_result.stdout }}"
