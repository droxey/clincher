---
# Steps 6-8: API keys, model config, Telegram channel, memory/RAG

# ── Step 6: API Keys and Model Configuration ─────────────────────────
- name: Configure LiteLLM as model proxy
  ansible.builtin.command: >
    docker exec openclaw openclaw config set agents.defaults.apiBase
    "http://openclaw-litellm:4000"
  changed_when: false

- name: Set default model
  ansible.builtin.command: >
    docker exec openclaw openclaw config set agents.defaults.model
    "{{ openclaw_default_model }}"
  changed_when: false

- name: Write Voyage API key to host tempfile
  ansible.builtin.copy:
    content: "VOYAGE_API_KEY={{ voyage_api_key }}"
    dest: "{{ openclaw_base_dir }}/monitoring/.voyage-env"
    owner: root
    group: root
    mode: "0600"
  no_log: true

- name: Copy Voyage API key into container
  ansible.builtin.command: docker cp {{ openclaw_base_dir }}/monitoring/.voyage-env openclaw:/tmp/.voyage-env
  changed_when: false
  no_log: true

- name: Install Voyage API key into container .env
  ansible.builtin.command: >
    docker exec openclaw sh -c
    'cat /tmp/.voyage-env > /root/.openclaw/.env && chmod 600 /root/.openclaw/.env && rm -f /tmp/.voyage-env'
  changed_when: false
  no_log: true

- name: Remove Voyage API key tempfile from host
  ansible.builtin.file:
    path: "{{ openclaw_base_dir }}/monitoring/.voyage-env"
    state: absent
  no_log: true

# ── Step 7: Channel Integration (Telegram) ───────────────────────────
- name: Configure Telegram channel
  when: telegram_enabled | bool
  block:
    - name: Write Telegram bot token to host tempfile
      ansible.builtin.copy:
        content: "{{ telegram_bot_token }}"
        dest: "{{ openclaw_base_dir }}/monitoring/.telegram-token"
        owner: root
        group: root
        mode: "0600"
      no_log: true

    - name: Copy Telegram token into container
      ansible.builtin.command: docker cp "{{ openclaw_base_dir }}/monitoring/.telegram-token" openclaw:/tmp/.tg-token
      changed_when: false
      no_log: true

    - name: Install Telegram token via file
      ansible.builtin.command: >
        docker exec openclaw sh -c
        'openclaw config set channels.telegram.token "$(cat /tmp/.tg-token)" && rm -f /tmp/.tg-token'
      changed_when: false
      no_log: true

    - name: Remove Telegram token tempfile from host
      ansible.builtin.file:
        path: "{{ openclaw_base_dir }}/monitoring/.telegram-token"
        state: absent
      no_log: true

    - name: Configure Telegram streaming (fixed in 2026.2.19+)
      ansible.builtin.command: >
        docker exec openclaw openclaw config set channels.telegram.streaming "progress"
      changed_when: false

# ── Step 8: Memory and RAG Configuration ─────────────────────────────
- name: Configure memory provider
  ansible.builtin.command: >
    docker exec openclaw openclaw config set memory.provider "{{ memory_provider }}"
  changed_when: false

- name: Configure memory model
  ansible.builtin.command: >
    docker exec openclaw openclaw config set memory.voyage.model "{{ memory_model }}"
  changed_when: false

- name: Build memory index
  ansible.builtin.command: docker exec openclaw openclaw memory index
  register: memory_index
  changed_when: false
  failed_when: false

- name: Show memory index build output on failure
  ansible.builtin.debug:
    msg: |
      Memory index build failed (rc={{ memory_index.rc }}).
      stdout: {{ memory_index.stdout | default('') }}
      stderr: {{ memory_index.stderr | default('') }}
  when: memory_index.rc != 0

- name: Verify memory index
  ansible.builtin.command: docker exec openclaw openclaw memory index --verify
  register: memory_verify
  changed_when: false
  failed_when: false

- name: Show memory index status
  ansible.builtin.debug:
    msg: "Memory index: {{ 'OK' if memory_verify.rc == 0 else 'FAILED — check Voyage API key and Smokescreen egress whitelist' }}"

- name: Fail if memory index verification failed
  ansible.builtin.fail:
    msg: "Memory index verification failed. Check Voyage API key, Smokescreen egress whitelist (*.voyageai.com), and container logs."
  when: memory_verify.rc != 0

# ── Restart to apply all integration config ───────────────────────────
- name: Restart OpenClaw to apply integration config
  ansible.builtin.command: docker compose restart openclaw
  args:
    chdir: "{{ openclaw_base_dir }}"
